## Sprawozdanie 3 DevOps
#Zajecia 8 


# Zajęcia9 
Pliki odpowiedzi dla wdrożeń nienadzorowanych

## Automatyzacja instalacji Fedory z wykorzystaniem Kickstart

### 1. Pobranie i przygotowanie środowiska

Pracę rozpoczęto od pobrania instalatora sieciowego Fedora NetInstall i zainstalowania maszyny wirtualnej na VirtualBox.

### 2. Sprawdzenie pliku odpowiedzi Anaconda

Po zakończeniu instalacji przełączono się na konto roota i sprawdzono zawartość katalogu domowego roota:
```
sudo su
ls -l /root
```
(screen)

Można zauważyć, że instalator Anaconda automatycznie generuje plik odpowiedzi  `anaconda-ks.cfg`.

Plik ten zawiera wszystkie odpowiedzi na pytania, które były udzielane ręcznie podczas procesu instalacji. Dzięki temu można go wykorzystać do stworzenia maszyny wzorcowej i przyspieszenia wdrażania systemu na wielu maszynach bez konieczności każdorazowego przechodzenia przez cały proces instalacji.



### 3. Modyfikacja pliku KickStart

Plik został dodany do repozytorium, delikatnie go zmodyfikowano:

-   dodano konfigurację źródeł repozytoriów:

```
url --mirrorlist=http://mirrors.fedoraproject.org/mirrorlist?repo=fedora-41&arch=x86_64
repo --name=update --mirrorlist=http://mirrors.fedoraproject.org/mirrorlist?repo=updates-released-f41&arch=x86_64

```

-   zapewniono, że zawsze będzie formatować całość

```
clearpart --all --initlabel

```

-   ustawiono hostname na inny niż domyślny  `localhost`

```
network --hostname=fedora-mruby.local
```
### 4. anaconda-ks.cfg

[](https://github.com/InzynieriaOprogramowaniaAGH/MDO2025_INO/tree/KM417392/ITE/GCL05/KM417392/Sprawozdanie3#4-anaconda-kscfg)

-   [anaconda-ks.cfg](https://github.com/InzynieriaOprogramowaniaAGH/MDO2025_INO/blob/KM417392/ITE/GCL05/KM417392/Sprawozdanie3/kickstart/anaconda-ks.cfg)
```
#version=DEVEL
# Generated by Anaconda 41.35
# Modified for Fedora unattended install

# Źródła repozytoriów
url --mirrorlist=http://mirrors.fedoraproject.org/mirrorlist?repo=fedora-41&arch=x86_64
repo --name=update --mirrorlist=http://mirrors.fedoraproject.org/mirrorlist?repo=updates-released-f41&arch=x86_64

# Układ klawiatury i język
keyboard --vckeymap=pl --xlayouts='pl'
lang pl_PL.UTF-8

# Sieć i nazwa hosta
network  --bootproto=dhcp --device=enp0s3 --ipv6=auto --activate
network  --hostname=fedora-mruby.local

# Pakiety
%packages
@^server-product-environment
%end

# Setup Agent po starcie
firstboot --enable

# Dysk
ignoredisk --only-use=sda
autopart
clearpart --all --initlabel

# Strefa czasowa
timezone Europe/Warsaw --utc

# Hasła
rootpw haslo123 --plaintext
user --groups=wheel --name=kasiam --password=haslo123 --plaintext --gecos="kasiam"

# Post install
%post --log=/root/post-install.log
echo "Instalacja zakończona pomyślnie." > /root/sukces.txt
%end

# Restart po instalacji
reboot

```

### 5. Automatyczna instalacja z użyciem Kickstart

Następnie stworzono nową maszynę wirtualną, korzystając z wcześniej pobranego obrazu ISO Fedora Server.

Zamiast standardowego rozpoczęcia instalacji:

1.  Na ekranie wyboru GRUB naciśnięto klawisz  `e`  w celu edycji parametrów rozruchu.
2.  Dodano na końcu linii zaczynającej się od linux parametr:
```
inst.ks=https://raw.githubusercontent.com/InzynieriaOprogramowaniaAGH/MDO2025_INO/JK414562/lab9/anaconda-ks.cfg
```
3.  Następnie naciśnięto kombinację klawiszy  `Ctrl`  +  `X`, co uruchomiło instalator z podanym plikiem odpowiedzi.

Instalator automatycznie rozpoczął instalację zgodnie z przepisami zawartymi w pliku Kickstart.
(screen)

## Rozszerzenie pliku odpowiedzi

Po wykonaniu testowej instalacji z użyciem domyślnego pliku `anaconda-ks.cfg`, utworzono nowy plik `ks.cfg`, który automatyzuje cały proces wdrożenia systemu Fedora oraz kompiluje i uruchamia aplikację stworzoną w ramach projektu xz.

Zgodnie z wymaganiami, rozszerzono plik odpowiedzi o:

-   instalację narzędzi do kompilacji oraz zależności projektu xz,
    
-   konfigurację użytkownika oraz przygotowanie testowego pliku tekstowego,
    
-   automatyczne pobranie, zbudowanie i uruchomienie programu `xz` po pierwszym starcie systemu,
    
-   pełne repozytoria i reboot po instalacji.

### Plik ks.cfg
```
#version=DEVEL
# Generated by Anaconda 41.35
# Modified to install and run xz project from GitHub

# Keyboard layouts
keyboard --vckeymap=pl --xlayouts='pl'

# System language
lang pl_PL.UTF-8

# Network configuration
network --bootproto=dhcp --device=enp0s3 --ipv6=auto --activate
network --hostname=fedora-xz.local

# System timezone
timezone Europe/Warsaw --utc

# Root password and user
rootpw haslo123 --plaintext
user --groups=wheel --name=kasiam --password=haslo123 --plaintext --gecos="kasiam"

# Disk partitioning
ignoredisk --only-use=sda
autopart
clearpart --all --initlabel

# Package selection
%packages
@^server-product-environment
git
gcc
make
autoconf
automake
libtool
wget
%end

# Setup agent
firstboot --enable

# Installation sources
url --mirrorlist=http://mirrors.fedoraproject.org/mirrorlist?repo=fedora-41&arch=x86_64
repo --name=update --mirrorlist=http://mirrors.fedoraproject.org/mirrorlist?repo=updates-released-f41&arch=x86_64

# Post-installation script
%post --log=/root/ks-post.log --interpreter=/bin/bash

# Klonowanie i budowanie projektu xz
mkdir -p /opt/xz
cd /opt/xz
git clone https://github.com/tukaani-project/xz.git
cd xz
./autogen.sh
./configure
make
make install

# Tworzenie testowego pliku do kompresji
echo "To jest testowy plik XZ" > /opt/test.txt

# Tworzenie skryptu uruchamiającego XZ
cat << 'EOF' > /usr/local/bin/run-xz.sh
#!/bin/bash
xz -z -k /opt/test.txt
EOF

chmod +x /usr/local/bin/run-xz.sh

# Tworzenie usługi systemd, która uruchomi xz przy starcie
cat << 'EOF' > /etc/systemd/system/run-xz.service
[Unit]
Description=Run XZ compression test at boot
After=network-online.target

[Service]
ExecStart=/usr/local/bin/run-xz.sh
Type=oneshot
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF

# Włącz usługę
systemctl enable run-xz.service

%end

# Reboot after installation
reboot
```

### Potwierdzenie działania

Po zakończeniu instalacji i automatycznym restarcie systemu jednostka `run-xz.service` została uruchomiona.

Logi systemd wskazują:

-   testowy plik `test.txt` został utworzony w katalogu `/opt`,
    
-   usługa `run-xz.service` uruchomiła skrypt `/usr/local/bin/run-xz.sh`,
    
-   skrypt wykonał polecenie kompresji `xz -z -k /opt/test.txt`,
    
-   wynikowy plik `test.txt.xz` został poprawnie wygenerowany.
    

Usługa zakończyła się bezbłędnie (`status=0/SUCCESS`) i ma status `enabled`, co oznacza, że uruchamia się przy każdym starcie systemu.

### Weryfikacja manualna

Aplikacja `xz` została zainstalowana lokalnie i uruchamiana poza kontenerem.  
W pliku odpowiedzi `ks.cfg` utworzono jednostkę `run-xz.service`, która automatycznie uruchamia komendę kompresji przy starcie systemu.

Aby zweryfikować działanie aplikacji, można wykonać następujące polecenie:
