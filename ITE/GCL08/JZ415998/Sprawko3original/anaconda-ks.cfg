

%packages
@^minimal-environment 
@core
wget
curl
git

dnf-plugins-core

%end

%post --log=/root/ks-post.log
echo "Kickstart post-installation script started"


echo "Installing Docker CE..."
dnf config-manager --add-repo https://download.docker.com/linux/fedora/docker-ce.repo

dnf install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin


echo "Enabling Docker service..."
systemctl enable docker.service


echo "Creating Nginx Docker container startup service..."
cat << EOF > /etc/systemd/system/run-nginx-container.service
[Unit]
Description=Run Nginx Docker Container on First Boot
Wants=network-online.target docker.service
After=network-online.target docker.service

ConditionPathExists=!/opt/nginx-container-started.flag

[Service]
Type=oneshot
RemainAfterExit=yes

ExecStartPre=/bin/sh -c 'count=0; until docker info >/dev/null 2>&1; do if [ "$count" -ge 12 ]; then echo "Docker did not start after 60s"; exit 1; fi; echo "Waiting for Docker daemon..."; sleep 5; count=$((count+1)); done'

ExecStart=/usr/bin/docker pull nginx:latest

ExecStart=/usr/bin/docker run --name nginx-server -d -p 80:80 --restart unless-stopped nginx:latest

ExecStartPost=/usr/bin/touch /opt/nginx-container-started.flag

[Install]
WantedBy=multi-user.target
EOF

systemctl enable run-nginx-container.service

echo "Kickstart post-installation script finished"
%end
