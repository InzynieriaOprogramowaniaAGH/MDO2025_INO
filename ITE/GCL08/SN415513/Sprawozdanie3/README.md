# LAB08

## Utworzenie maszyny
![](1.png)

## Nadanie nazwy uÅ¼ytkownika, hosta, oraz sprawdzenie dziaÅ‚ania sshd i tar
![](2.png)
![](2_5.png)

## Migawka maszyny i eksport
![](3.png)

## Instalacja ansible a gÃ³wnej maszynie
![](4.png)

## Postawienie polaczenia ssh (ubuntu main -> ansible_target)

### Sprawdzenie adresu ip
![](5.png)

### Skopiowanie (juÅ¼ istniejÄ…cych kluczy) na ansible-target
![](5_5.png)

### PoÅ‚Ä…czenie siÄ™ z gÅ‚Ã³wnej maszyny do targetu
![](5_6.png)

### Zezwolenie na logowanie bez hasÅ‚a na configu fedory 
![](5_7.png)
  
## ustalenie nazw za pomocÄ… hostnamectl
![](6_1.png)
![](6_2.png)

## Postawienie polaczenia ssh (ansible_target -> ubuntu_main)

### #Zapisanie ubuntu_main w /etc/hosts na ansible target
![](7_1.png)

### Zmiana configu ssh (/etc/ssh/sshd_config - na ubuntu_main)
![](7_2.png)

### UsuniÄ™cie hasÅ‚a
![](7_3.png)

### Testowe poÅ‚Ä…czenie niewymahgajÄ…ce wspisywania hasÅ‚a
![](7_4.png)

## Utworzenie pliku .ini, uzupeÅ‚nienie i ping
![](8.png)
```
[Orchestrators]
ubuntu_main  ansible_user=szymon

[Endpoints]
ansible-target ansible_user=ansible
```
## Playbook - procedury

### plik .yml
```
- name: Ping all hosts
  hosts: all
  gather_facts: no
  tasks:
    - name: Ping
      ansible.builtin.ping:

- name: Copy inventory file to Endpoints
  hosts: Endpoints
  gather_facts: no
  tasks:
    - name: Copy inventory file
      ansible.builtin.copy:
        src: inventory.ini
        dest: /tmp/inventory.ini

- name: Ping again to compare output
  hosts: all
  gather_facts: no
  tasks:
    - name: Ping after copy
      ansible.builtin.ping:

- name: Restart services on Fedora Endpoints
  hosts: Endpoints
  gather_facts: no
  tasks:
    - name: Restart sshd service
      ansible.builtin.service:
        name: sshd
        state: restarted
      ignore_errors: yes

    - name: Restart rngd service
      ansible.builtin.service:
        name: rngd
        state: restarted
      ignore_errors: yes
```
### 
![](9.png)
  
## ZarzÄ…dzanie stworzonym artefaktem
 
Plik deploy_deb.yml definiujÄ…cy instrukcje:
```
---
- name: Deploy binary in Docker container
  hosts: Endpoints
  become: yes
  vars:
    binary_file: "mypkg/usr/local/bin/weechat"
    deb_file: "weechat.deb"
    dest_dir: "/opt/weechat"        
    image_name: "ubuntu:22.04"
    container_name: "weechat_container"

  tasks:
    - name: Ensure Docker is installed
      become: true
      command: dnf install -y docker
      args:
        creates: /usr/bin/docker

    - name: Start Docker service
      ansible.builtin.service:
        name: docker
        state: started
        enabled: yes

    - name: Create directory on target host
      ansible.builtin.file:
        path: "{{ dest_dir }}"
        state: directory
        mode: '0755'

    - name: Copy binary to target host
      ansible.builtin.copy:
        src: "{{ binary_file }}"
        dest: "{{ dest_dir }}/weechat"
        mode: '0755'

    - name: Copy .deb file to target host
      ansible.builtin.copy:
        src: "{{ deb_file }}"
        dest: "{{ dest_dir }}/weechat.deb"
        mode: '0644'

    - name: Run container with mounted binary and install dependencies
      community.docker.docker_container:
        name: "{{ container_name }}"
        image: "{{ image_name }}"
        state: started
        volumes:
          - "{{ dest_dir }}:/weechat"
        command: >
          bash -c "apt update && apt install -y /weechat/weechat.deb && /weechat/weechat"
        command: sleep infinity
        tty: true
        detach: true
```

### PomyÅ›le wykonanie wszystkich krokÃ³w:
![](10.png)

### Weryfikacja poprawnoÅ›ci zaÅ‚Ä…czenia voluminu na kontener i dziaÅ‚ania aplikacji
![](11.png)
![](12.png)

# ZajÄ™cia 09

## Plik odpowiedzi z systemu fedora
```
# Generated by Anaconda 41.35
# Generated by pykickstart v3.58
#version=DEVEL

# Keyboard layouts
keyboard --vckeymap=us --xlayouts='us'
# System language
lang en_US.UTF-8

# Run the Setup Agent on first boot
firstboot --enable

# Generated using Blivet version 3.11.0
ignoredisk --only-use=sda
autopart
# Partition clearing information
clearpart --none --initlabel

# System timezone
timezone Europe/Warsaw --utc

#Root password
rootpw --lock

# Ustawienie hosta
network --hostname=fedora41-host
```

* Zapoznaj siÄ™ z [dokumentacjÄ… pliku odpowiedzi](https://pykickstart.readthedocs.io/en/latest/kickstart-docs.html) i zmodyfikuj swÃ³j plik:
  * Plik odpowiedzi moÅ¼e nie zawieraÄ‡ wzmianek na temat potrzebnych repozytoriÃ³w. JeÅ¼eli Twoja pÅ‚yta instalacyjna nie zawiera pakietÃ³w, dodaj wzmiankÄ™ o repozytoriach skÄ…d je pobraÄ‡. Na przykÅ‚ad, dla systemu Fedora 38:
      * `url --mirrorlist=http://mirrors.fedoraproject.org/mirrorlist?repo=fedora-38&arch=x86_64`
      * `repo --name=update --mirrorlist=http://mirrors.fedoraproject.org/mirrorlist?repo=updates-released-f38&arch=x86_64`
  * Plik odpowiedzi moÅ¼e zakÅ‚adaÄ‡ pusty dysk. Zapewnij, Å¼e zawsze bÄ™dzie formatowaÄ‡ caÅ‚oÅ›Ä‡, stosujÄ…c `clearpart --all`
  * Ustaw *hostname* inny niÅ¼ domyÅ›lny `localhost`
* UÅ¼yj pliku odpowiedzi do przeprowadzenia [instalacji nienadzorowanej](https://docs.fedoraproject.org/en-US/fedora/f36/install-guide/advanced/Kickstart_Installations/)
  * ğŸŒµ Uruchom nowÄ… maszynÄ™ wirtualnÄ… z pÅ‚yty ISO i wskaÅ¼ instalatorowi przygotowany plik odpowiedzi stosownÄ… dyrektywÄ…
---
* Rozszerz plik odpowiedzi o repozytoria i oprogramowanie potrzebne do uruchomienia programu, zbudowanego w ramach projektu - naszego *pipeline'u*. 
  * W przypadku kontenera, jest to po prostu Docker.
    * UtwÃ³rz w sekcji `%post` mechanizm umoÅ¼liwiajÄ…cy pobranie i uruchomienie kontenera
    * JeÅ¼eli efektem pracy pipeline'u nie byÅ‚ kontener, a aplikacja samodzielna - zainstaluj jÄ…
    * PamiÄ™taj, Å¼e **Docker zadziaÅ‚a dopiero na uruchomionym systemie!** - nie da siÄ™ wdaÄ‡ w interakcjÄ™ z Dockerem z poziomu instalatora systemu: polecenia `docker run` nie powiodÄ… siÄ™ na tym etapie. Nie zadziaÅ‚a teÅ¼ `systemctl start` (ale `systemctl enable` juÅ¼ tak)
  * Gdy program pracuje poza kontenerem, potrzebny jest caÅ‚y Å‚aÅ„cuch dependencji oraz sam program.
    * UÅ¼yj sekcji `%post`, by pobraÄ‡ z Jenkinsa zbudowany artefakt
    * RozwaÅ¼ stworzenie repozytorium ze swoim programem i dodanie go dyrektywÄ… `repo` oraz zainstalowanie pakietu sekcjÄ… `%packages`
    * JeÅ¼eli nie jest to moÅ¼liwe/wykonalne, uÅ¼yj dowolnego serwera SFTP/FTP/HTTP aby "zahostowaÄ‡" program - nastÄ™pnie pobierz go z tak hostujÄ…cego serwera (stosujÄ…c np. `wget`)
    * UmieÅ›Ä‡ program w Å›cieÅ¼ce stosownej dla binariÃ³w `/usr/local/bin/`
    * Zadbaj w sekcji `%packages`, by system zainstalowaÅ‚ wszystkie dependencje potrzebne do dziaÅ‚ania programu
  * Wybierz oprogramowanie na podstawie poprzedniego sprawozdania.
* Zadbaj o automatyczne ponowne uruchomienie na koÅ„cu instalacji
* Zapewnij, by od razu po pierwszym uruchomieniu systemu, oprogramowanie zostaÅ‚o uruchomione (w dowolny sposÃ³b)

