# Generated by Anaconda 41.35
# Generated by pykickstart v3.58
#version=DEVEL

# Keyboard layout
keyboard --vckeymap=pl --xlayouts='pl'
# System language
lang pl_PL.UTF-8

# Network configuration
network  --bootproto=dhcp --device=enp0s3 --ipv6=auto --activate
network  --hostname=nacymonhost

# Repository configuration
url --mirrorlist=http://mirrors.fedoraproject.org/mirrorlist?repo=fedora-41&arch=x86_64
repo --name=update --mirrorlist=http://mirrors.fedoraproject.org/mirrorlist?repo=updates-released-f41&arch=x86_64

# Packages to install
%packages
@^custom-environment
docker
wget
curl
bash
%end

# Partitioning
ignoredisk --only-use=sda
autopart
clearpart --none --initlabel

# Time zone
timezone Europe/Warsaw --utc

# User configuration
rootpw --iscrypted --allow-ssh $y$j9T$yy8OR/agtVZD4OLQAj6Ap1.N$P0kUHjULI/s9mip8eeH/sMGnKg.s.//tui4FeWeVgN0
user --groups=wheel --name=nacymon --password=$y$j9T$e7esf2FHm5CU5pJCI7POp/6K$pcZSiVqrk3nJb6Pi64MylW.dDggnSsBUirLnBT2Iea9 --iscrypted

# Enable setup agent on first boot
firstboot --enable

# Post-installation configuration
%post --log=/root/ks-post.log --interpreter=/bin/bash

# Enable Docker to start on boot
systemctl enable docker

# Create startup script for the Node-RED CI container
cat << 'EOF' > /usr/local/bin/start-node-red-ci.sh
#!/bin/bash
# Wait until Docker is fully running
until systemctl is-active --quiet docker; do
  sleep 1
done

# Check if the container already exists, if not â€“ run it
if ! docker ps -a --format '{{.Names}}' | grep -q '^container-test$'; then
  docker run -d --name container-test -p 3000:3000 nacymon/node-red-ci
fi
EOF

# Make the script executable
chmod +x /usr/local/bin/start-node-red-ci.sh

# Create a systemd service to run the container at boot
cat << 'EOF' > /etc/systemd/system/node-red-ci.service
[Unit]
Description=Start Node-RED CI container
After=network-online.target docker.service
Requires=docker.service

[Service]
ExecStart=/usr/local/bin/start-node-red-ci.sh
Type=oneshot
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF

# Enable the custom systemd service
systemctl enable node-red-ci.service

%end

# Automatically reboot after installation is complete
reboot
