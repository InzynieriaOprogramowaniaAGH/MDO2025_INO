# ---------------------------------------------------------------------------
# Fedora 38 Server – Kickstart z Docker CE i autostartem kontenera
# ---------------------------------------------------------------------------

keyboard --vckeymap=pl --xlayouts='pl'
lang pl_PL.UTF-8

url  --mirrorlist=http://mirrors.fedoraproject.org/mirrorlist?repo=fedora-38&arch=x86_64
repo --name=updates --mirrorlist=http://mirrors.fedoraproject.org/mirrorlist?repo=updates-released-f38&arch=x86_64


repo --name=docker-ce --baseurl=https://download.docker.com/linux/fedora/38/x86_64/stable


network --bootproto=dhcp --ipv6=auto --activate --hostname=harambe.localdomain

ignoredisk --only-use=sda
clearpart --all --initlabel
autopart

timezone Europe/Warsaw --utc

rootpw  --iscrypted --allow-ssh $y$j9T$k3bQKxtopLwWyUKwD0BDo46H$QhGDBDB0PK1l...
user    --groups=wheel --name=user --gecos="user"


%packages
@^server-product-environment
# Docker & tools
dnf-plugins-core
device-mapper
device-mapper-persistent-data
lvm2
docker-ce
docker-ce-cli
containerd.io
%end


%post --log=/root/ks-post.log
# --- repo (na wypadek gdyby Anaconda je pominęła) --------------------------
cat >/etc/yum.repos.d/docker-ce.repo <<'EOF'
[docker-ce-stable]
name=Docker CE Stable - $basearch
baseurl=https://download.docker.com/linux/fedora/\$releasever/\$basearch/stable
enabled=1
gpgcheck=1
gpgkey=https://download.docker.com/linux/fedora/gpg
EOF

dnf -y update docker-ce docker-ce-cli containerd.io || true

systemctl enable docker

# --- skrypt, który pobierze i uruchomi kontener przy pierwszym boot-cie ----
cat >/usr/local/bin/setup-container.sh <<'EOSH'
#!/usr/bin/env bash
set -euo pipefail

# Czekamy maks. 30 s aż docker.socket wystartuje
for i in {1..30}; do
  systemctl is-active docker && break
  sleep 1
done

/usr/bin/docker pull bambusscooby/irssi-runtime:11
/usr/bin/docker run -d --name irssi-container --restart=unless-stopped bambusscooby/irssi-runtime:11

systemctl disable firstboot-container.service
EOSH
chmod +x /usr/local/bin/setup-container.sh

# --- jednostka systemd wykonywana raz po starcie Dockera -------------------
cat >/etc/systemd/system/firstboot-container.service <<'EOUNIT'
[Unit]
Description=One-shot: pobierz i uruchom kontener irssi-runtime
Requires=docker.service
After=docker.service

[Service]
Type=oneshot
ExecStart=/usr/local/bin/setup-container.sh
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOUNIT

# włączamy jednostkę
systemctl enable firstboot-container.service
%end

# 10. Ukończ instalację i zrestartuj
reboot
