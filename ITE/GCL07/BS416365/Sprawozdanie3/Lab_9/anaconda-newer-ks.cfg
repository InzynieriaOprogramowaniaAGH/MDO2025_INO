#version=DEVEL

# Keyboard layouts
keyboard --vckeymap=pl --xlayouts='pl'
# System language
lang pl_PL.UTF-8

# Network information
network  --bootproto=dhcp --device=eth0 --ipv6=auto --activate --hostname=host-p-odpowiedzi-post

url --mirrorlist=http://mirrors.fedoraproject.org/mirrorlist?repo=fedora-41&arch=x86_64
repo --name=updates --mirrorlist=http://mirrors.fedoraproject.org/mirrorlist?repo=updates-released-f41&arch=x86_64
repo --name=docker-ce-stable --baseurl=https://download.docker.com/linux/fedora/41/x86_64/stable

%packages
@^custom-environment
docker-ce
docker-ce-cli
containerd.io
%end

# Run the Setup Agent on first boot
firstboot --enable

# Generated using Blivet version 3.11.0
ignoredisk --only-use=sda
autopart
# Partition clearing information
clearpart --all --initlabel

# System timezone
timezone Europe/Warsaw --utc

# Root password
rootpw --iscrypted $y$j9T$a246fi5kT/yRXtgXckttNu36$0N4D6CHberfYfkxFU1jCufUWbFkmrsxCAPH..l7Y.R4

# Post-instalacja: uruchomienie kontenera
%post
set -euxo pipefail
exec > /var/log/ks-post.log 2>&1

echo "[INFO] Włączanie usługi docker..."
systemctl enable docker

echo "[INFO] Tworzenie jednostki systemd do uruchamiania kontenera curl-final..."

# Użyj latest lub konkretny tag (np. v13) — tutaj: v1 dla spójności
CURL_IMAGE="bskubel/curl-final:v1"

cat > /etc/systemd/system/curl-final.service <<EOF
[Unit]
Description=Run curl-final container
Requires=docker.service network-online.target
After=docker.service network-online.target

[Service]
Restart=always
ExecStartPre=-/usr/bin/docker rm -f curl-final
ExecStart=/usr/bin/docker run --name curl-final -dit --restart always ${CURL_IMAGE} tail -f /dev/null
ExecStop=/usr/bin/docker stop curl-final

[Install]
WantedBy=multi-user.target
EOF

echo "[INFO] Włączenie curl-final.service..."
systemctl enable curl-final.service
%end

# Restart systemu po instalacji
reboot