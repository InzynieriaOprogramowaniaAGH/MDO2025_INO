---
- name: Basic operations
  hosts: all
  gather_facts: true
  become: yes
  vars:
    inventory_owner: "{{ 'devops' if inventory_hostname == 'ansible-main' else 'ansible' }}"

  tasks:
    - name: Send ping request
      ping:

    - name: Copy inventory file
      ansible.builtin.copy:
        src: ~/ansible/inventory.ini
        dest: /tmp/inventory.ini
        owner: "{{ inventory_owner }}"
        group: "{{ inventory_owner }}"
        mode: "7777"

    - name: Update system packages
      block:
        - name: Update packages (skip kernel)
          ansible.builtin.package:
            name: "*"
            state: latest
            update_cache: yes
          register: update_result
          notify: reboot_if_needed
          become: true

    - name: Restart services
      service:
        name: "{{ item }}"
        state: restarted
      loop:
        - sshd
        - rngd

    - name: Skip message for control node
      debug:
        msg: "Skipping package updates on control node (ansible-main)"
      when: inventory_hostname == 'ansible-main'

  handlers:
    - name: reboot_if_needed
      ansible.builtin.reboot:
        msg: "Reboot initiated by Ansible"
        connect_timeout: 5
        reboot_timeout: 600
        pre_reboot_delay: 0
        post_reboot_delay: 30
      when:
        - update_result.changed
        - inventory_hostname != 'ansible-main'