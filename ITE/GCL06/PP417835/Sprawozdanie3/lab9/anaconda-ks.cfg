# Generated by Anaconda 41.35
# Generated by pykickstart v3.58
#version=DEVEL

# Keyboard layouts
keyboard --vckeymap=pl --xlayouts='pl'
# System language
lang en_US.UTF-8

# Network information
network  --bootproto=dhcp --device=eth0 --ipv6=auto --activate --hostname=curl-final-host

url --mirrorlist=http://mirrors.fedoraproject.org/mirrorlist?repo=fedora-41&arch=x86_64
repo --name=update --mirrorlist=http://mirrors.fedoraproject.org/mirrorlist?repo=updates-released-f41&arch=x86_64
# Dodano repozytorium Dockera dla Fedory 41
repo --name=docker-ce-stable --baseurl=https://download.docker.com/linux/fedora/41/x86_64/stable

# Run the Setup Agent on first boot
firstboot --enable

ignoredisk --only-use=sda
clearpart --all --initlabel
autopart --type=btrfs

# System timezone
timezone Europe/Warsaw --utc

#Root password
rootpw --lock
user --groups=wheel --name=lab9 --password=password --plaintext

%packages
@^server-product-environment

docker-ce
docker-ce-cli
containerd.io
wget
%end

%post --log=/root/kickstart-post.log


DOCKER_IMAGE_NAME="pawpodw2/curl_publish"
DOCKER_IMAGE_TAG="v15" 
FULL_DOCKER_IMAGE="${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}"


systemctl enable docker
systemctl start docker


echo "download Docker Image: ${FULL_DOCKER_IMAGE}" >> /root/kickstart-post.log
docker pull "${FULL_DOCKER_IMAGE}" >> /root/kickstart-post.log 2>&1


echo "Test" >> /root/kickstart-post.log
docker run --rm "${FULL_DOCKER_IMAGE}" curl --version || echo "Test curl --version fail ${FULL_DOCKER_IMAGE}" >> /root/kickstart-post.log


echo "systemd container ${FULL_DOCKER_IMAGE}" >> /root/kickstart-post.log
cat > /etc/systemd/system/curl_final.service <<EOF
[Unit]
Description=Curl Final Container
Requires=docker.service network-online.target
After=docker.service network-online.target

[Service]
Restart=always
ExecStartPre=-/usr/bin/docker rm -f curl_final

ExecStart=/usr/bin/docker run --name curl_final "${FULL_DOCKER_IMAGE}" tail -f /dev/null
ExecStop=/usr/bin/docker stop curl_final

[Install]
WantedBy=multi-user.target
EOF


echo "run service" >> /root/kickstart-post.log
systemctl enable curl_final.service
systemctl start curl_final.service

%end

reboot

