#version=DEVEL

keyboard --vckeymap=pl --xlayouts='pl'
lang pl_PL.UTF-8
timezone Europe/Warsaw --utc

network --bootproto=dhcp --device=eth0 --activate
network --hostname=fedora-mruby.local

url --mirrorlist=http://mirrors.fedoraproject.org/mirrorlist?repo=fedora-41&arch=x86_64
repo --name=update --mirrorlist=http://mirrors.fedoraproject.org/mirrorlist?repo=updates-released-f41&arch=x86_64

ignoredisk --only-use=sda
clearpart --all --initlabel
autopart
bootloader --location=mbr

rootpw haslo123 --plaintext
user --groups=wheel --name=kasiam --password=haslo123 --plaintext --gecos="kasiam"

%packages
@^minimal-environment
@container-management
wget
curl
%end

firstboot --enable
reboot

%post --log=/root/ks-post.log

# Dodaj repozytorium Docker CE ręcznie (bez config-manager)
cat <<EOF > /etc/yum.repos.d/docker-ce.repo
[docker-ce-stable]
name=Docker CE Stable - \$basearch
baseurl=https://download.docker.com/linux/fedora/\$releasever/\$basearch/stable
enabled=1
gpgcheck=1
gpgkey=https://download.docker.com/linux/fedora/gpg
EOF

# Zainstaluj Dockera
dnf install -y docker-ce docker-ce-cli containerd.io

# Włącz i uruchom Docker
systemctl enable docker
systemctl start docker

# Dodaj użytkownika kasiam do grupy docker
usermod -aG docker kasiam

# Przygotuj katalog i pobierz script.rb
mkdir -p /opt/mruby
cd /opt/mruby
wget -O script.rb https://raw.githubusercontent.com/InzynieriaOprogramowaniaAGH/MDO2025_INO/KM417392/ITE/GCL05/KM417392/Sprawozdanie2/mruby-pipeline/script.rb

# Stwórz usługę systemd, która:
# - wykonuje docker pull
# - uruchamia kontener z nazwą
# - montuje wolumin z /opt/mruby/script.rb do /app/script.rb
cat <<EOF > /etc/systemd/system/mruby-container.service
[Unit]
Description=Run MRuby container with mounted script.rb
After=network.target docker.service
Requires=docker.service

[Service]
Restart=always
ExecStartPre=/usr/bin/docker rm -f mruby-container
ExecStartPre=/usr/bin/docker pull kasiam23/mruby:latest
ExecStart=/usr/bin/docker run --name mruby-container \\
  -v /opt/mruby/script.rb:/app/script.rb \\
  kasiam23/mruby:latest
ExecStop=/usr/bin/docker stop mruby-container

[Install]
WantedBy=multi-user.target
EOF

# Włącz usługę przy starcie
systemctl enable mruby-container.service

%end
