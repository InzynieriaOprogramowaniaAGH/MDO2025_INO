---
- name: Zainstaluj wymagane pakiety do Dockera i narzędzi
  dnf:
    name:
      - docker
      - docker-compose
      - nodejs
      - curl
    state: present
    update_cache: yes

- name: Uruchom i włącz usługę dockera
  systemd:
    name: docker
    state: started
    enabled: yes
  notify: Restart docker

- name: Pobierz obraz aplikacji z DockerHuba
  community.docker.docker_image:
    name: "{{ docker_image_name }}"
    source: pull

- name: Uruchom kontener z aplikacją
  community.docker.docker_container:
    name: "{{ docker_container_name }}"
    image: "{{ docker_image_name }}"
    state: started
    restart_policy: always
    ports:
      - "{{ host_port }}:{{ app_port }}"


- name: Sprawdź dostępność aplikacji za pomocą curl
  shell: curl -s -o /dev/null -w "%{http_code}" http://localhost:3000
  register: curl_result
  retries: 10
  delay: 3
  until: curl_result.stdout is match("2[0-9]{2}")

- name: Wypisz kod odpowiedzi HTTP
  debug:
    msg: "Kod odpowiedzi HTTP z aplikacji: {{ curl_result.stdout }}"
