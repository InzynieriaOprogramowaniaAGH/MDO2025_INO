# Generated by Anaconda 41.35
# Generated by pykickstart v3.58
#version=DEVEL
# Keyboard layouts
keyboard --vckeymap=pl --xlayouts='pl'
# System language
lang pl_PL.UTF-8
# Default hostname change
network --bootproto=dhcp --device=eth0 --onboot=on --hostname=kickstart
# Repository
url --mirrorlist=http://mirrors.fedoraproject.org/mirrorlist?repo=fedora-41&arch=x86_64
repo --name=update --mirrorlist=http://mirrors.fedoraproject.org/mirrorlist?repo=updates-released-f41&arch=x86_64
repo --name=docker-ce-stable --baseurl=https://download.docker.com/linux/fedora/41/x86_64/stable --cost=100

%packages
@^custom-environment
# Minimal install packages from the user's description
tar
openssh-server
# Added packages for docker and app deployment
docker-ce
docker-ce-cli
containerd.io
docker-compose-plugin
curl
%end

# Run the Setup Agent on first boot
firstboot --enable
# Generated using Blivet version 3.11.0
ignoredisk --only-use=sda
autopart
# Partition clearing information
clearpart --none --initlabel
# System timezone
timezone Europe/Warsaw --utc
# Root password
rootpw --iscrypted --allow-ssh $y$j9T$askU93gHDIYO2y8RyB.MKPPD$W7JpUDFHWnktkWJWjUrmPSqvZ0HS1Aw6fdO/.fIqz55
user --groups=wheel --name=skwasny --password=$y$j9T$y/ljs73eWbJeYh62swN9.Pbt$/axoHX56WzlN.j7Vq1J8Vz.hkyO2X87s1Ct47/32USB --iscrypted --gecos="Szczepan Kwa≈õny"

%post --log=/root/ks-post.log
# Enable and start Docker service
systemctl enable docker
systemctl start docker

# Pull Docker images
docker pull mysql:latest
docker pull sauer88/exam-seat-arrangement:latest

# Create docker-compose.yml
cat <<EOF > /root/docker-compose.yml
version: '3.8'
services:
  db:
    image: mysql:latest
    container_name: mysql-db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword123 
      MYSQL_DATABASE: exam_db 
      MYSQL_USER: app_user 
      MYSQL_PASSWORD: app_password123
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql

  app:
    image: sauer88/exam-seat-arrangement:latest
    container_name: spring-app
    restart: always
    ports:
      - "8080:8080"
    depends_on:
      - db
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://db:3306/exam_db
      SPRING_DATASOURCE_USERNAME: app_user
      SPRING_DATASOURCE_PASSWORD: app_password123
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
    links:
      - db

volumes:
  mysql_data:
EOF

# Create systemd service for docker-compose
cat <<EOF > /etc/systemd/system/myapp.service
[Unit]
Description=My Application Docker Compose
Requires=docker.service
After=docker.service

[Service]
Type=oneshot
RemainAfterExit=yes
WorkingDirectory=/root
ExecStart=/usr/bin/docker-compose up -d
ExecStop=/usr/bin/docker-compose down
TimeoutStartSec=0

[Install]
WantedBy=multi-user.target
EOF

# Enable and start the custom service
systemctl enable myapp.service
systemctl start myapp.service

# Wait for MySQL to be ready (simple delay, consider a more robust check)
echo "Waiting for MySQL to initialize..."
sleep 60 

# Check if the application is running
curl http://localhost:8080/api/building

%end

# Reboot after installation
reboot
