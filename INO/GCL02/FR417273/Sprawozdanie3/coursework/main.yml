- name: Create directory /home/ansible/cjson
  become: yes
  file:
    path: /home/ansible/cjson
    state: directory
    mode: '0755'

- name: Copy files to endpoint
  copy:
    src: "files/{{ item }}"
    dest: /home/ansible/cjson
  loop:
    - test_cjson.c
    - cjson-1.0.0.rpm

- name: Install python3-requests
  become: yes
  dnf:
    name: python3-requests
    state: present

- name: Install Docker
  become: yes
  dnf:
    name: docker
    state: present

- name: Ensure Docker is started
  become: yes
  service:
    name: docker
    state: started
    enabled: true

- name: Start fedora container
  community.docker.docker_container:
    name: cjson
    image: fedora:41
    state: started
    command: sleep infinity
    volumes:
      - /home/ansible/cjson:/mnt:z

- name: Install gcc and tools
  community.docker.docker_container_exec:
    container: cjson
    command: dnf install -y gcc make rpm2cpio cpio

- name: Unpack RPM directly to root filesystem
  community.docker.docker_container_exec:
    container: cjson
    command: bash -c "cd / && rpm2cpio /mnt/cjson-1.0.0.rpm | cpio -idmv"

- name: Create symlink libcjson.so.1 â†’ libcjson.so
  community.docker.docker_container_exec:
    container: cjson
    command: ln -sf /usr/lib/libcjson.so /usr/lib/libcjson.so.1

- name: Compile source file
  community.docker.docker_container_exec:
    container: cjson
    command: gcc /mnt/test_cjson.c -o /mnt/program -lcjson

- name: Run program
  community.docker.docker_container_exec:
    container: cjson
    command: bash -c "LD_LIBRARY_PATH=/usr/lib /mnt/program"
  register: result

- name: Print the result of the program
  debug:
    var: result.stdout

