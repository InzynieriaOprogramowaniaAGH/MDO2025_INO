pipeline {
  agent any

  stages {
    stage('Build image') {
        steps {
            sh '''
            docker build \
                --target builder \
                -t pytest-examples-builder:0.1.0 \
                -f INO/GCL02/PK417538/pipeline/Dockerfile .
            '''
        }
    }


    stage('Test image') {
      steps {
        sh '''
          docker build \
            --target tester \
            -t pytest-examples-tester:0.1.0 \
            -f INO/GCL02/PK417538/pipeline/Dockerfile .
        '''
      }
    }

    stage('Package / Deploy artifacts') {
      steps {
        // zbuduj stage deploy i wyciÄ…gnij paczki
        sh '''
          docker build \
            --target deploy \
            -t pytest-examples-deploy:0.1.0 \
            -f INO/GCL02/PK417538/pipeline/Dockerfile .
          CONTAINER=$(docker create pytest-examples-deploy:0.1.0)
          docker cp $CONTAINER:/packages /home/user/local-pypi/packages
          docker rm $CONTAINER
        '''
      }
    }
  }

  post {
    always {
      archiveArtifacts artifacts: 'test.log, dist/**', fingerprint: true
    }
  }
}
