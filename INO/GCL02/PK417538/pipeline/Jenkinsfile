pipeline {
  agent any

  environment {
    IMAGE      = "pytest-examples-build:0.1.0"
    DOCKERFILE = "INO/GCL02/PK417538/pipeline/Dockerfile"
    CONTEXT    = "INO/GCL02/PK417538/pipeline"
  }

  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Build Docker image') {
      steps {
        sh """
          docker build -t ${IMAGE} \
            -f ${DOCKERFILE} \
            ${CONTEXT}
        """
      }
    }

    stage('Install & Test in Docker') {
      steps {
        sh """
          docker run --rm \
            -v ${WORKSPACE}:/workspace \
            -w /workspace/${CONTEXT} \
            ${IMAGE} \
            bash -lc "make install && make test | tee /workspace/test.log"
        """
      }
    }

    stage('Package sdist') {
      steps {
        sh """
          docker run --rm \
            -v ${WORKSPACE}:/workspace \
            -w /workspace/${CONTEXT} \
            ${IMAGE} \
            bash -lc "poetry build -f sdist -o /workspace/dist"
        """
        sh """
          mkdir -p ~/local-pypi/packages
          cp dist/*.tar.gz ~/local-pypi/packages/program-0.1.0.tar.gz
        """
      }
    }

    stage('Publish to local PyPI') {
      steps {
        echo "Paczka w ~/local-pypi/packages – teraz możesz wystawić to jako proste PyPI (np. python -m http.server 8081)"
      }
    }
  }

  post {
    always {
      archiveArtifacts artifacts: 'test.log, dist/*.tar.gz', fingerprint: true
    }
  }
}
