pipeline {
  agent any

  stages {
    stage('Build image') {
        steps {
            sh '''
            docker build \
                --target builder \
                -t pytest-examples-builder:0.1.0 \
                -f INO/GCL02/PK417538/pipeline/Dockerfile .
            '''
        }
    }


    stage('Test image') {
      steps {
        sh '''
          docker build \
            --target tester \
            -t pytest-examples-tester:0.1.0 \
            -f INO/GCL02/PK417538/pipeline/Dockerfile .
        '''
      }
    }

    stage('Package / Deploy artifacts') {
        steps {
            sh '''
            # run the deploy image, mounting the workspace/local-pypi as /packages
            docker run --rm \
                -v ${WORKSPACE}/local-pypi:/packages \
                pytest-examples-deploy:0.1.0
            '''
        }
    }

  }

  post {
    always {
      archiveArtifacts artifacts: 'test.log, dist/**', fingerprint: true
    }
  }
}
