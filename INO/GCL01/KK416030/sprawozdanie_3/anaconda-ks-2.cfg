# Generated by Anaconda 41.35
# Generated by pykickstart v3.58
#version=DEVEL

keyboard --vckeymap=pl --xlayouts='pl'
lang pl_PL.UTF-8
timezone Europe/Warsaw --utc

rootpw --iscrypted --allow-ssh $y$j9T$0BSruj//SiUG3IsrLZxhAm6u$bcoBHKVd0cSAq1gvcCAZZqj0X5X0axUbdk4vfU7Ua91
user --groups=wheel --name=kaleta --password=root --plaintext --gecos="kaleta"

firstboot --enable

ignoredisk --only-use=sda
clearpart --all --initlabel
autopart

# Pakiety do instalacji
%packages
@^custom-environment
docker
curl
unzip
%end

# Skrypt po instalacji (uruchamiany po pierwszym rozruchu)
%post --log=/root/post-install.log

# Włączenie Dockera do autostartu
systemctl enable docker

# Utworzenie katalogu na raport
mkdir -p /srv/report

# Pobranie archiwum ZIP z raportem z GitHuba
curl -L "https://github.com/InzynieriaOprogramowaniaAGH/MDO2025_INO/raw/refs/heads/KK416030/INO/GCL01/KK416030/sprawozdanie_2/archive%20(3).zip" -o /tmp/report.zip

# Rozpakowanie ZIP-a
unzip /tmp/report.zip -d /tmp/extracted

# Skopiowanie zawartości lcov-report do katalogu serwowanego
cp -r /tmp/extracted/html_report/files/lcov-report/* /srv/report/

# Tworzenie usługi systemd do uruchamiania kontenera z NGINX
cat <<EOF > /etc/systemd/system/html-report.service
[Unit]
Description=Serwer raportu HTML (nginx w Dockerze)
Requires=docker.service
After=docker.service

[Service]
Restart=always
ExecStart=/usr/bin/docker run --rm --name html-server -p 8888:80 -v /srv/report:/usr/share/nginx/html:ro nginx:alpine
ExecStop=/usr/bin/docker stop html-server

[Install]
WantedBy=multi-user.target
EOF

# Włączenie usługi HTML do autostartu
systemctl enable html-report.service

%end

# Automatyczny restart po instalacji
reboot
