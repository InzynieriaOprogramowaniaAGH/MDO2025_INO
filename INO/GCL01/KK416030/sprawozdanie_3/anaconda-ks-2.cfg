# Generated by Anaconda 41.35
# Generated by pykickstart v3.58
#version=DEVEL

keyboard --vckeymap=pl --xlayouts='pl'
lang pl_PL.UTF-8
timezone Europe/Warsaw --utc

rootpw --iscrypted --allow-ssh $y$j9T$0BSruj//SiUG3IsrLZxhAm6u$bcoBHKVd0cSAq1gvcCAZZqj0X5X0axUbdk4vfU7Ua91
user --groups=wheel --name=kaleta --password=root --plaintext --gecos="kaleta"

firstboot --enable

ignoredisk --only-use=sda
clearpart --all --initlabel
autopart

# Pakiety do instalacji
%packages
@^custom-environment
docker
curl
unzip
%end

%post --log=/root/post-install.log

# Włączenie Dockera
systemctl enable docker

# Utwórz katalog na raport
mkdir -p /srv/report

# Pobierz plik ZIP
curl -L "https://github.com/InzynieriaOprogramowaniaAGH/MDO2025_INO/raw/refs/heads/KK416030/INO/GCL01/KK416030/sprawozdanie_2/archive%20(3).zip" -o /root/report.zip

# Zainstaluj unzip (na wypadek gdyby nie był obecny)
dnf install -y unzip

# Rozpakuj do /root/extracted (nie tymczasowo!)
unzip /root/report.zip -d /root/extracted

# Skopiuj właściwą zawartość do /srv/report
# Skopiuj raport do katalogu serwowanego przez nginx
cp -r /root/extracted/archive/artifacts/coverage/lcov-report/* /srv/report/

# Ustaw odpowiednie prawa
chmod -R a+r /srv/report
chmod -R a+X /srv/report

# Ustaw SELinux context, aby kontener miał dostęp
chcon -Rt svirt_sandbox_file_t /srv/report

# Dodaj usługę systemd do uruchamiania kontenera
cat <<EOF > /etc/systemd/system/html-report.service
[Unit]
Description=Serwer raportu HTML (nginx w Dockerze)
Requires=docker.service
After=docker.service

[Service]
Restart=always
ExecStart=/usr/bin/docker run --rm --name html-server -p 8888:80 -v /srv/report:/usr/share/nginx/html:ro nginx:alpine
ExecStop=/usr/bin/docker stop html-server

[Install]
WantedBy=multi-user.target
EOF

# Włącz usługę do autostartu
systemctl enable html-report.service

%end


# Automatyczny restart po instalacji
reboot
