Started by user mati

Obtained INO/GCL01/MG417201/redis-ci-cd/Jenkinsfile from git https://github.com/InzynieriaOprogramowaniaAGH/MDO2025_INO
[Pipeline] Start of Pipeline
[Pipeline] node
Running on Jenkins
 in /var/jenkins_home/workspace/redis-ci-cd-pipeline
[Pipeline] {
[Pipeline] stage
[Pipeline] { (Declarative: Checkout SCM)
[Pipeline] checkout
The recommended git tool is: git
No credentials specified
 > git rev-parse --resolve-git-dir /var/jenkins_home/workspace/redis-ci-cd-pipeline/.git # timeout=10
Fetching changes from the remote Git repository
 > git config remote.origin.url https://github.com/InzynieriaOprogramowaniaAGH/MDO2025_INO # timeout=10
Fetching upstream changes from https://github.com/InzynieriaOprogramowaniaAGH/MDO2025_INO
 > git --version # timeout=10
 > git --version # 'git version 2.39.5'
 > git fetch --tags --force --progress -- https://github.com/InzynieriaOprogramowaniaAGH/MDO2025_INO +refs/heads/*:refs/remotes/origin/* # timeout=10
 > git rev-parse refs/remotes/origin/MG417201^{commit} # timeout=10
Checking out Revision cf6c3c8a70eb0070665a9e54ccab1525bca4b047 (refs/remotes/origin/MG417201)
 > git config core.sparsecheckout # timeout=10
 > git checkout -f cf6c3c8a70eb0070665a9e54ccab1525bca4b047 # timeout=10
Commit message: "MG417201: report 3 modification"
 > git rev-list --no-walk baa140a53be8b0bb9cc86854fe080ee813bb701e # timeout=10
[Pipeline] }
[Pipeline] // stage
[Pipeline] withEnv
[Pipeline] {
[Pipeline] isUnix
[Pipeline] withEnv
[Pipeline] {
[Pipeline] sh
+ docker inspect -f . mihlsap/my-ci-image:minikube
.
[Pipeline] }
[Pipeline] // withEnv
[Pipeline] withDockerContainer
Jenkins seems to be running inside container 1e8a41a9dde20b8e56044c54e51b6c2bd743609409106dbdfc3881b48d8f954a
$ docker run -t -d -u 0:0 --privileged --network=host --entrypoint= --volume=/var/run/docker.sock:/var/run/docker.sock --volume=/home/mati/.kube:/root/.kube --volume=/home/mati/.minikube:/root/.minikube -w /var/jenkins_home/workspace/redis-ci-cd-pipeline --volumes-from 1e8a41a9dde20b8e56044c54e51b6c2bd743609409106dbdfc3881b48d8f954a -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** -e ******** mihlsap/my-ci-image:minikube cat
$ docker top 63db622d2015ed85ed166fa865469f56a1ad61d951019a16de16675cf829f32f -eo pid,comm
[Pipeline] {
[Pipeline] withEnv
[Pipeline] {
[Pipeline] stage
[Pipeline] { (Checkout)
[Pipeline] checkout
The recommended git tool is: git
No credentials specified
Warning: JENKINS-30600: special launcher org.jenkinsci.plugins.docker.workflow.WithContainerStep$Decorator$1@40c4d797; decorates hudson.Launcher$LocalLauncher@19d2bf will be ignored (a typical symptom is the Git executable not being run inside a designated container)
 > git rev-parse --resolve-git-dir /var/jenkins_home/workspace/redis-ci-cd-pipeline/.git # timeout=10
Fetching changes from the remote Git repository
 > git config remote.origin.url https://github.com/InzynieriaOprogramowaniaAGH/MDO2025_INO # timeout=10
Fetching upstream changes from https://github.com/InzynieriaOprogramowaniaAGH/MDO2025_INO
 > git --version # timeout=10
 > git --version # 'git version 2.39.5'
 > git fetch --tags --force --progress -- https://github.com/InzynieriaOprogramowaniaAGH/MDO2025_INO +refs/heads/*:refs/remotes/origin/* # timeout=10
 > git rev-parse refs/remotes/origin/MG417201^{commit} # timeout=10
Checking out Revision cf6c3c8a70eb0070665a9e54ccab1525bca4b047 (refs/remotes/origin/MG417201)
 > git config core.sparsecheckout # timeout=10
 > git checkout -f cf6c3c8a70eb0070665a9e54ccab1525bca4b047 # timeout=10
Commit message: "MG417201: report 3 modification"
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Init Kubernetes CLI)
[Pipeline] sh
+ echo Aktualizuję ścieżki w pliku kubeconfig...
Aktualizuję ścieżki w pliku kubeconfig...
+ sed s|/home/mati/.minikube|/root/.minikube|g /root/.kube/config
+ mv /root/.kube/config.patched /root/.kube/config
+ echo Sprawdzam status Minikube na hoście...
Sprawdzam status Minikube na hoście...
+ kubectl get nodes
+ echo Minikube aktywny. Gotowe do działania.
Minikube aktywny. Gotowe do działania.
+ kubectl get nodes
NAME       STATUS   ROLES           AGE     VERSION
minikube   Ready    control-plane   5h54m   v1.32.0
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Build)
[Pipeline] dir
Running in /var/jenkins_home/workspace/redis-ci-cd-pipeline/INO/GCL01/MG417201/redis-ci-cd
[Pipeline] {
[Pipeline] sh
+ docker build -t redis_build:1.0 -f Dockerfile.build.redis .
DEPRECATED: The legacy builder is deprecated and will be removed in a future release.
            Install the buildx component to build images with BuildKit:
            https://docs.docker.com/go/buildx/

Sending build context to Docker daemon  37.02MB

Step 1/5 : FROM ubuntu:latest AS redis_build
 ---> a0e45e2ce6e6
Step 2/5 : RUN apt update && apt install -y     build-essential tcl git
 ---> Using cache
 ---> ffb63fa8a0aa
Step 3/5 : RUN git clone https://github.com/redis/redis.git
 ---> Using cache
 ---> 5649b50598bc
Step 4/5 : WORKDIR /redis
 ---> Using cache
 ---> 4212738c1deb
Step 5/5 : RUN make
 ---> Using cache
 ---> 2c86287280c4
Successfully built 2c86287280c4
Successfully tagged redis_build:1.0
[Pipeline] }
[Pipeline] // dir
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Test)
[Pipeline] dir
Running in /var/jenkins_home/workspace/redis-ci-cd-pipeline/INO/GCL01/MG417201/redis-ci-cd
[Pipeline] {
[Pipeline] sh
+ docker build -t redis_test:1.0 -f Dockerfile.test.redis .
DEPRECATED: The legacy builder is deprecated and will be removed in a future release.
            Install the buildx component to build images with BuildKit:
            https://docs.docker.com/go/buildx/

Sending build context to Docker daemon  37.02MB

Step 1/3 : FROM redis_build AS redis_test
 ---> 936186acb738
Step 2/3 : WORKDIR /redis
 ---> Using cache
 ---> 859a088772b4
Step 3/3 : RUN ./runtest --single unit/type/string --single unit/type/list   --tags "-slow -needs:save -needs:repl -external:skip -latency-monitor -needs:latency"
 ---> Using cache
 ---> b0fab766d5fc
Successfully built b0fab766d5fc
Successfully tagged redis_test:1.0
[Pipeline] sh
+ mkdir -p logs
+ docker run --rm redis_test:1.0
[Pipeline] }
[Pipeline] // dir
Post stage
[Pipeline] archiveArtifacts
Archiving artifacts
Recording fingerprints
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Package Runtime)
[Pipeline] dir
Running in /var/jenkins_home/workspace/redis-ci-cd-pipeline/INO/GCL01/MG417201/redis-ci-cd
[Pipeline] {
[Pipeline] sh
+ docker build -t redis_runtime2.0 -f Dockerfile.runtime .
DEPRECATED: The legacy builder is deprecated and will be removed in a future release.
            Install the buildx component to build images with BuildKit:
            https://docs.docker.com/go/buildx/

Sending build context to Docker daemon  37.02MB

Step 1/11 : FROM redis_build:1.0 AS builder
 ---> 2c86287280c4
Step 2/11 : FROM ubuntu:latest
 ---> a0e45e2ce6e6
Step 3/11 : RUN apt-get update  && apt-get install -y --no-install-recommends ca-certificates  && rm -rf /var/lib/apt/lists/*
 ---> Using cache
 ---> 7047ee9629c8
Step 4/11 : RUN mkdir -p /data  && useradd --no-create-home --shell /usr/sbin/nologin redis
 ---> Using cache
 ---> b82d8f125801
Step 5/11 : COPY --from=builder /redis/src/redis-server /usr/local/bin/redis-server
 ---> Using cache
 ---> bb2ce997eea1
Step 6/11 : COPY --from=builder /redis/src/redis-cli    /usr/local/bin/redis-cli
 ---> Using cache
 ---> a2a1ba703036
Step 7/11 : COPY --from=builder /redis/redis.conf        /etc/redis/redis.conf
 ---> Using cache
 ---> 5581961b8a5c
Step 8/11 : RUN chown -R redis:redis /data
 ---> Using cache
 ---> 90f9edd1f993
Step 9/11 : USER redis
 ---> Using cache
 ---> a86ea913d317
Step 10/11 : EXPOSE 6379
 ---> Using cache
 ---> a58c8824de47
Step 11/11 : CMD ["redis-server", "/etc/redis/redis.conf", "--dir", "/data"]
 ---> Using cache
 ---> 94ae2cf14d22
Successfully built 94ae2cf14d22
Successfully tagged redis_runtime2.0:latest
[Pipeline] }
[Pipeline] // dir
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Push to Docker Hub)
[Pipeline] withCredentials
Masking supported pattern matches of $DOCKER_PASS
[Pipeline] {
[Pipeline] sh
+ docker login -u mihlsap --password-stdin
+ echo ****

WARNING! Your credentials are stored unencrypted in '/root/.docker/config.json'.
Configure a credential helper to remove this warning. See
https://docs.docker.com/go/credential-store/

Login Succeeded
+ docker tag redis_runtime2.0 mihlsap/redis_runtime2.0
+ docker push mihlsap/redis_runtime2.0
Using default tag: latest
The push refers to repository [docker.io/mihlsap/redis_runtime2.0]
0b8b9f9796dc: Preparing
b3ee05f07cbc: Preparing
0964e85b1d2b: Preparing
51be8d6101cc: Preparing
05563e6a7458: Preparing
95c2cef1b2a5: Preparing
8901a649dd5a: Preparing
95c2cef1b2a5: Waiting
8901a649dd5a: Waiting
51be8d6101cc: Layer already exists
0964e85b1d2b: Layer already exists
0b8b9f9796dc: Layer already exists
05563e6a7458: Layer already exists
b3ee05f07cbc: Layer already exists
95c2cef1b2a5: Layer already exists
8901a649dd5a: Layer already exists
latest: digest: sha256:332f2215d7308067d7c9dab2e04f19092e60d268cd08410411ddd5cad0228293 size: 1785
[Pipeline] }
[Pipeline] // withCredentials
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Deploy to cloud)
[Pipeline] withCredentials
Masking supported pattern matches of $DOCKER_PASS
[Pipeline] {
[Pipeline] sh
+ echo ****
+ docker login -u mihlsap --password-stdin
Login Succeeded
+ docker pull mihlsap/redis_runtime2.0
Using default tag: latest
latest: Pulling from mihlsap/redis_runtime2.0
Digest: sha256:332f2215d7308067d7c9dab2e04f19092e60d268cd08410411ddd5cad0228293
Status: Image is up to date for mihlsap/redis_runtime2.0:latest
docker.io/mihlsap/redis_runtime2.0:latest
+ docker rm -f redis-runtime
redis-runtime
+ docker run -d --name redis-runtime -p 6379:6379 mihlsap/redis_runtime2.0
efdc386cd6026067b523ed8d6c25b697756d36c8391c73108fa11b9eb004d2b2
+ sleep 3
+ docker exec redis-runtime redis-cli PING
PONG
[Pipeline] }
[Pipeline] // withCredentials
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Deploy to Kubernetes)
[Pipeline] sh
+ kubectl apply -f INO/GCL01/MG417201/redis-ci-cd/redis-deploy.yaml
deployment.apps/redis-deploy unchanged
[Pipeline] sh
+ kubectl rollout status deployment/redis-deploy
deployment "redis-deploy" successfully rolled out
[Pipeline] sh
+ kubectl get pods
NAME                            READY   STATUS    RESTARTS   AGE
redis-deploy-577579bbcf-gstx4   1/1     Running   0          4h
redis-deploy-577579bbcf-pznvc   1/1     Running   0          4h
redis-deploy-577579bbcf-tqs29   1/1     Running   0          4h
redis-deploy-577579bbcf-wcsrs   1/1     Running   0          4h
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Verify K8s Rollout)
[Pipeline] dir
Running in /var/jenkins_home/workspace/redis-ci-cd-pipeline/INO/GCL01/MG417201/redis-ci-cd
[Pipeline] {
[Pipeline] sh
+ chmod +x check-rollout.sh
[Pipeline] sh
+ ./check-rollout.sh redis-deploy 60
Waiting up to 60 s for rollout of deployment/redis-deploy ...
Rollout of redis-deploy succeeded: 4/4 replicas available.
[Pipeline] }
[Pipeline] // dir
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Declarative: Post Actions)
[Pipeline] echo
Pipeline zakończony – artefakt gotowy i wdrożony.
[Pipeline] }
[Pipeline] // stage
[Pipeline] }
[Pipeline] // withEnv
[Pipeline] }
$ docker stop --time=1 63db622d2015ed85ed166fa865469f56a1ad61d951019a16de16675cf829f32f
$ docker rm -f --volumes 63db622d2015ed85ed166fa865469f56a1ad61d951019a16de16675cf829f32f
[Pipeline] // withDockerContainer
[Pipeline] }
[Pipeline] // withEnv
[Pipeline] }
[Pipeline] // node
[Pipeline] End of Pipeline
Finished: SUCCESS
